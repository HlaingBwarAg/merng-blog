let AuthenticationError,UserInputError,Post,User,postValidate,validateObjectId;_804‍.x([["default",()=>_804‍.o]]);_804‍.w("apollo-server-express",[["AuthenticationError",["AuthenticationError"],function(v){AuthenticationError=v}],["UserInputError",["UserInputError"],function(v){UserInputError=v}]]);_804‍.w("../models",[["Post",["Post"],function(v){Post=v}],["User",["User"],function(v){User=v}]]);_804‍.w("../validator",[["postValidate",["postValidate"],function(v){postValidate=v}],["validateObjectId",["validateObjectId"],function(v){validateObjectId=v}]]);



const resolvers = {
  Query: {
    posts: async (parent, args, context, info) => {
      const post = await Post.find({}).populate('author').populate({ path: 'comments', populate: { path: 'author' } })
      if (!post) throw new Error(`${post} is something wrong`)
      return post
    },
    post: async (parent, { postId }, context, info) => {
      validateObjectId(postId)
      const post = await Post.findById(postId).populate('author').populate({ path: 'comments', populate: { path: 'author' } })
      if (!post) throw new Error(`${post} is something wrong`)
      return post
    }
  },
  Mutation: {
    createPost: async (parent, args, { req }, info) => {
      const { userId } = req.session
      const { title, description } = args
      await postValidate.validateAsync({ title, description }, { abortEarly: false })
      let post = await Post.create({ author: userId, title, description })
      post = await post.populate('author')
      if (post) {
        return post
      } else {
        throw new Error(`${post} is something wrong`)
      }
    },
    deletePost: async (parent, { postId }, { req }, info) => {
      // if was delete a post should remove all comment to belong to post
      const { userId } = req.session
      validateObjectId(postId)
      try {
        const post = await Post.findById(postId).populate('author')
        if (post && userId === post.author._id.toString()) {
          await Post.deleteOne(post)
          return 'Post deleted successfully'
        } else {
          throw new AuthenticationError('Action not allowed')
        }
      } catch (error) {
        throw new Error(error, 'error with post ID')
      }
    },
    likePost: async (parent, { postId }, { req }, info) => {
      const { userId } = req.session
      const user = await User.findById(userId)
      validateObjectId(postId)
      const post = await Post.findById(postId).populate('author').populate({ path: 'comments', populate: { path: 'author' } })
      if (post) {
        if (post.likes.find(like => like.username === user.name)) {
          post.likes = post.likes.filter(like => like.username !== user.name)
        } else {
          post.likes.push({
            username: user.name,
            createdAt: new Date().toISOString()
          })
        }
        await post.save()
        return post
      } else {
        throw new UserInputError('Post not found')
      }
    }
  },
  Post: {
    likeCount: (parent) => parent.likes.length,
    commentCount: (parent) => parent.comments.length
  }
}

_804‍.d(resolvers);
