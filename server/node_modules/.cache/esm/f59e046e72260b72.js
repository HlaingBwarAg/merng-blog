let UserInputError,AuthenticationError,Comment,Post,validateObjectId;_722‍.x([["default",()=>_722‍.o]]);_722‍.w("apollo-server-express",[["UserInputError",["UserInputError"],function(v){UserInputError=v}],["AuthenticationError",["AuthenticationError"],function(v){AuthenticationError=v}]]);_722‍.w("../models",[["Comment",["Comment"],function(v){Comment=v}],["Post",["Post"],function(v){Post=v}]]);_722‍.w("../validator",[["validateObjectId",["validateObjectId"],function(v){validateObjectId=v}]]);



const resolvers = {
  Query: {
    comments: async (parent, args, context, info) => {
      return await Comment.find({}).populate('author')
    }
  },
  Mutation: {
    createComment: async (parent, { postId, text }, { req }, info) => {
      const { userId } = req.session
      validateObjectId(postId)
      const post = await Post.findById(postId)
      if (post) {
        let comment = await Comment.create({ author: userId, text })
        comment = await comment.populate('author')
        await Post.findByIdAndUpdate(
          { _id: postId },
          { $push: { comments: comment._id } },
          { new: true }
        )
        return comment
      } else {
        throw new UserInputError('Post Not Found')
      }
    },
    deleteComment: async (parent, { postId, commentId }, { req }, info) => {
      const { userId } = req.session
      validateObjectId(postId, commentId)
      const post = await Post.findById(postId).populate('author').populate({ path: 'comments', populate: { path: 'author' } })
      if (post) {
        const comment = post.comments.map(cmt => cmt)
        // cmtid koe if nak check tint tal
        const cmtId = comment.find(a => a._id.toString() === commentId)
        if (comment && cmtId && cmtId.author._id.toString() === userId) {
          await Comment.deleteOne(cmtId)
          return post
        } else {
          throw new AuthenticationError('Action Not Allowed')
        }
      } else {
        throw new UserInputError('Post Not Found')
      }
    }
  }
}

_722‍.d(resolvers);
